# 测试驱动开发工作流

本技能确保所有代码开发遵循 TDD 原则，实现全面的测试覆盖。

## 触发条件

- 编写新功能或特性
- 修复 Bug（先写复现 Bug 的测试）
- 重构现有代码
- 添加 API 端点
- 创建新组件
- 实现核心业务逻辑

## 与角色系统的配合

| 角色    | TDD 使用场景                  |
| ------- | ----------------------------- |
| `/lead` | 定义测试策略、审查测试覆盖率  |
| `/dev`  | 执行 TDD 循环、编写测试和实现 |
| `/qa`   | 补充边界测试、E2E 测试        |

**典型流程**：

```
/lead → 定义接口和测试策略
  ↓
/dev → TDD 循环（RED → GREEN → REFACTOR）
  ↓
/qa → 验证覆盖率、补充边界测试
  ↓
/commit → 提交代码和测试
```

---

## 核心原则

### 1. 测试先于代码

**永远**先写测试，再写实现代码使测试通过。

### 2. TDD 循环

```
RED → GREEN → REFACTOR → REPEAT

RED:      写一个失败的测试
GREEN:    写最少的代码使测试通过
REFACTOR: 改进代码，保持测试绿色
REPEAT:   下一个场景
```

### 3. 覆盖率要求

| 代码类型     | 覆盖率要求 |
| ------------ | ---------- |
| 普通业务代码 | 80%+       |
| 金融计算     | 100%       |
| 认证逻辑     | 100%       |
| 安全关键代码 | 100%       |
| 核心业务逻辑 | 100%       |

---

## 参考资源

> 📚 **详细示例和框架配置请参阅子文件：**
>
> - [完整 TDD 示例](./tdd-example.md) - 从需求到实现的完整会话
> - [测试框架与配置](./frameworks.md) - Mock 模式、覆盖率配置、常用命令

---

## 必须测试的边界情况

| 类型           | 示例                      | 测试目的   |
| -------------- | ------------------------- | ---------- |
| Null/Undefined | `null`, `undefined`       | 空值处理   |
| 空值           | `""`, `[]`, `{}`          | 空集合处理 |
| 边界值         | `0`, `1`, `-1`, `MAX_INT` | 边界行为   |
| 类型错误       | 传入错误类型              | 类型防御   |
| 网络错误       | 请求失败、超时            | 错误恢复   |
| 并发           | 同时多个请求              | 竞态条件   |
| 大数据         | 10000+ 条记录             | 性能边界   |
| 特殊字符       | Unicode、Emoji、SQL 注入  | 安全边界   |

---

## 测试反模式

### ❌ 测试实现细节

```typescript
// 错误：测试内部状态
expect(component.state.count).toBe(5);
```

### ✅ 测试用户可见行为

```typescript
// 正确：测试用户看到的内容
expect(screen.getByText("计数: 5")).toBeInTheDocument();
```

### ❌ 测试相互依赖

```typescript
// 错误：依赖前一个测试的状态
test("创建用户", () => {
  /* ... */
});
test("更新同一用户", () => {
  /* 依赖上一个测试 */
});
```

### ✅ 测试相互独立

```typescript
// 正确：每个测试独立设置数据
test("创建用户", () => {
  const user = createTestUser();
  // 测试逻辑
});

test("更新用户", () => {
  const user = createTestUser();
  // 独立的测试数据
});
```

### ❌ 脆弱的选择器

```typescript
// 错误：依赖 CSS 类名
await page.click(".css-class-xyz");
```

### ✅ 语义化选择器

```typescript
// 正确：使用语义化选择器
await page.click('button:has-text("提交")');
await page.click('[data-testid="submit-button"]');
```

---

## 测试质量检查清单

### 提交前检查

- [ ] 所有公共函数有单元测试
- [ ] 所有 API 端点有集成测试
- [ ] 关键用户流程有 E2E 测试
- [ ] 边界情况已覆盖（null、空、无效）
- [ ] 错误路径已测试（不只是 happy path）
- [ ] 外部依赖已 Mock
- [ ] 测试相互独立（无共享状态）
- [ ] 测试名称描述清晰
- [ ] 断言具体且有意义
- [ ] 覆盖率达到 80%+

### 持续集成

```bash
# 推荐的 CI 命令
npm test -- --coverage --ci --reporter=dot
```

---

## 最佳实践

1. **测试先行** - 始终 TDD，先写测试
2. **单一断言** - 每个测试聚焦一个行为
3. **描述性命名** - 清楚说明测试什么
4. **AAA 模式** - Arrange-Act-Assert 结构
5. **Mock 外部依赖** - 隔离单元测试
6. **测试边界** - null、undefined、空、大值
7. **测试错误路径** - 不只测试 happy path
8. **保持快速** - 单元测试 < 50ms
9. **清理副作用** - 测试后无残留
10. **审查覆盖报告** - 识别盲点

---

## 成功指标

- ✅ 80%+ 代码覆盖率
- ✅ 所有测试通过（绿色）
- ✅ 无跳过或禁用的测试
- ✅ 快速执行（单元测试 < 30s）
- ✅ E2E 覆盖关键用户流程

---

**记住**：测试不是可选项。它是支持自信重构、快速开发和生产可靠性的安全网。

> **TDD 格言**：没有测试的代码就是遗留代码。
