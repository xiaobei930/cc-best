# Claude Code PR å®¡æŸ¥å·¥ä½œæµ
# åœ¨ PR åˆ›å»ºæˆ–æ›´æ–°æ—¶è‡ªåŠ¨è¿›è¡Œä»£ç å®¡æŸ¥
#
# é…ç½®è¯´æ˜:
# 1. éœ€è¦è®¾ç½® ANTHROPIC_API_KEY secret
# 2. å¯é€‰: GITHUB_TOKEN ç”¨äº PR è¯„è®ºï¼ˆé»˜è®¤å·²æä¾›ï¼‰
#
# å‚è€ƒ: https://code.claude.com/docs/en/github-actions

name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    # å¯é€‰: é™åˆ¶è§¦å‘çš„æ–‡ä»¶ç±»å‹
    # paths:
    #   - '**.ts'
    #   - '**.tsx'
    #   - '**.py'
    #   - '**.go'

# é˜²æ­¢åŒä¸€ PR å¤šæ¬¡è§¦å‘æ—¶é‡å¤è¿è¡Œ
concurrency:
  group: claude-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  review:
    runs-on: ubuntu-latest
    # å¯é€‰: ä»…å¯¹é draft PR è¿è¡Œ
    if: github.event.pull_request.draft == false

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²ä»¥è·å– diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Get Changed Files
        id: changed-files
        run: |
          # è·å–å˜æ›´æ–‡ä»¶åˆ—è¡¨
          files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | head -50)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # ç»Ÿè®¡å˜æ›´
          added=$(git diff --diff-filter=A --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          modified=$(git diff --diff-filter=M --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          deleted=$(git diff --diff-filter=D --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          echo "summary=+$added ~$modified -$deleted files" >> $GITHUB_OUTPUT

      - name: Run Claude Code Review
        id: review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # åˆ›å»ºå®¡æŸ¥æç¤º
          cat > /tmp/review-prompt.md << 'PROMPT'
          è¯·å®¡æŸ¥è¿™ä¸ª PR çš„ä»£ç å˜æ›´ã€‚é‡ç‚¹å…³æ³¨:

          1. **ä»£ç è´¨é‡**: å¯è¯»æ€§ã€å‘½åè§„èŒƒã€ä»£ç ç»„ç»‡
          2. **æ½œåœ¨é—®é¢˜**: Bugã€è¾¹ç•Œæƒ…å†µã€é”™è¯¯å¤„ç†
          3. **å®‰å…¨æ€§**: è¾“å…¥éªŒè¯ã€æ•æ„Ÿæ•°æ®å¤„ç†
          4. **æ€§èƒ½**: æ˜æ˜¾çš„æ€§èƒ½é—®é¢˜
          5. **æœ€ä½³å®è·µ**: æ˜¯å¦éµå¾ªé¡¹ç›®è§„èŒƒ

          å˜æ›´æ–‡ä»¶åˆ—è¡¨:
          ${{ steps.changed-files.outputs.files }}

          è¯·ä»¥ç»“æ„åŒ–æ–¹å¼è¾“å‡ºå®¡æŸ¥ç»“æœ:
          - ä½¿ç”¨ âœ… æ ‡è®°æ²¡é—®é¢˜çš„éƒ¨åˆ†
          - ä½¿ç”¨ âš ï¸ æ ‡è®°å»ºè®®æ”¹è¿›çš„éƒ¨åˆ†
          - ä½¿ç”¨ âŒ æ ‡è®°å¿…é¡»ä¿®å¤çš„é—®é¢˜

          æœ€åç»™å‡ºæ€»ä½“è¯„ä»·: APPROVE / REQUEST_CHANGES / COMMENT
          PROMPT

          # è¿è¡Œ Claude Code å®¡æŸ¥
          claude --print "$(cat /tmp/review-prompt.md)" > /tmp/review-result.md 2>&1 || true

          # è¾“å‡ºç»“æœ
          echo "review<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/review-result.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const review = `${{ steps.review.outputs.review }}`;
            const summary = `${{ steps.changed-files.outputs.summary }}`;

            const body = `## ğŸ¤– Claude Code Review

            **å˜æ›´ç»Ÿè®¡**: ${summary}

            ---

            ${review}

            ---
            <sub>ğŸ” ç”± Claude Code è‡ªåŠ¨å®¡æŸ¥ | [é…ç½®æ–‡æ¡£](https://code.claude.com/docs/en/github-actions)</sub>
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Summary
        run: |
          echo "## ğŸ¤– Claude Code Review" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**å˜æ›´**: ${{ steps.changed-files.outputs.summary }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å®¡æŸ¥ç»“æœå·²å‘å¸ƒåˆ° PR è¯„è®ºä¸­ã€‚" >> $GITHUB_STEP_SUMMARY
