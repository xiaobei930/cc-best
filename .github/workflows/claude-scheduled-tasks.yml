# Claude Code å®šæ—¶ä»»åŠ¡å·¥ä½œæµ
# è‡ªåŠ¨åŒ–æ‰§è¡Œå‘¨æœŸæ€§ç»´æŠ¤ä»»åŠ¡
#
# ä»»åŠ¡åˆ—è¡¨:
# - æœˆåº¦: æ–‡æ¡£åŒæ­¥æ£€æŸ¥
# - å‘¨åº¦: ä»£ç è´¨é‡æ‰«æ
# - åŒå‘¨: ä¾èµ–å®‰å…¨å®¡è®¡
#
# é…ç½®è¯´æ˜:
# 1. éœ€è¦è®¾ç½® ANTHROPIC_API_KEY secret
# 2. éœ€è¦è®¾ç½® PAT_TOKEN (Personal Access Token) ç”¨äºåˆ›å»º PR

name: Claude Scheduled Tasks

on:
  schedule:
    # æ¯æœˆ 1 å· UTC 2:00 (åŒ—äº¬æ—¶é—´ 10:00)
    - cron: '0 2 1 * *'
    # æ¯å‘¨ä¸€ UTC 3:00 (åŒ—äº¬æ—¶é—´ 11:00)
    - cron: '0 3 * * 1'
  workflow_dispatch:
    inputs:
      task:
        description: 'é€‰æ‹©è¦è¿è¡Œçš„ä»»åŠ¡'
        required: true
        type: choice
        options:
          - all
          - docs-sync
          - code-quality
          - dependency-audit

# é˜²æ­¢å¤šä¸ªå®šæ—¶ä»»åŠ¡åŒæ—¶è¿è¡Œ
concurrency:
  group: claude-scheduled
  cancel-in-progress: false

jobs:
  # ============================================
  # æ–‡æ¡£åŒæ­¥æ£€æŸ¥ï¼ˆæœˆåº¦ï¼‰
  # ============================================
  docs-sync:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.task == 'all' || github.event.inputs.task == 'docs-sync') ||
      (github.event_name == 'schedule' && github.event.schedule == '0 2 1 * *')

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Check Documentation Sync
        id: docs-check
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cat > /tmp/docs-prompt.md << 'PROMPT'
          è¯·æ£€æŸ¥é¡¹ç›®æ–‡æ¡£çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§:

          1. æ£€æŸ¥ README.md ä¸å®é™…åŠŸèƒ½æ˜¯å¦ä¸€è‡´
          2. æ£€æŸ¥ CLAUDE.md æ˜¯å¦åŒ…å«å¿…è¦çš„é¡¹ç›®ä¿¡æ¯
          3. æ£€æŸ¥ .claude/ ç›®å½•ä¸‹çš„ README æ–‡ä»¶æ˜¯å¦ä¸å®é™…å†…å®¹åŒ¹é…
          4. æ£€æŸ¥ API æ–‡æ¡£ï¼ˆå¦‚æœæœ‰ï¼‰æ˜¯å¦ä¸ä»£ç åŒæ­¥

          è¾“å‡ºéœ€è¦æ›´æ–°çš„æ–‡æ¡£åˆ—è¡¨å’Œå…·ä½“å»ºè®®ã€‚
          å¦‚æœå‘ç°é—®é¢˜ï¼Œåˆ›å»ºä¸€ä¸ªç®€æ´çš„ä¿®å¤æ–¹æ¡ˆã€‚
          PROMPT

          claude --print "$(cat /tmp/docs-prompt.md)" > /tmp/docs-result.md 2>&1 || true
          cat /tmp/docs-result.md

      - name: Create Issue if Needed
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const result = fs.readFileSync('/tmp/docs-result.md', 'utf8');

            // æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æ›´æ–°çš„å†…å®¹
            if (result.includes('éœ€è¦æ›´æ–°') || result.includes('ä¸ä¸€è‡´')) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ“š æœˆåº¦æ–‡æ¡£åŒæ­¥æ£€æŸ¥æŠ¥å‘Š',
                body: `## æ–‡æ¡£åŒæ­¥æ£€æŸ¥ç»“æœ\n\n${result}\n\n---\n<sub>ğŸ¤– ç”± Claude Code è‡ªåŠ¨ç”Ÿæˆ | ${new Date().toISOString().split('T')[0]}</sub>`,
                labels: ['documentation', 'automated']
              });
            }

  # ============================================
  # ä»£ç è´¨é‡æ‰«æï¼ˆå‘¨åº¦ï¼‰
  # ============================================
  code-quality:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.task == 'all' || github.event.inputs.task == 'code-quality') ||
      (github.event_name == 'schedule' && github.event.schedule == '0 3 * * 1')

    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Code Quality Scan
        id: quality-scan
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cat > /tmp/quality-prompt.md << 'PROMPT'
          è¯·å¯¹é¡¹ç›®è¿›è¡Œä»£ç è´¨é‡æ‰«æï¼Œæ£€æŸ¥ä»¥ä¸‹æ–¹é¢:

          1. **ä»£ç å¼‚å‘³**: è¿‡é•¿å‡½æ•°ã€æ·±å±‚åµŒå¥—ã€é‡å¤ä»£ç 
          2. **å‘½åè§„èŒƒ**: å˜é‡ã€å‡½æ•°ã€æ–‡ä»¶å‘½åæ˜¯å¦ä¸€è‡´
          3. **æ³¨é‡Šè´¨é‡**: æ˜¯å¦æœ‰è¿‡æ—¶æˆ–è¯¯å¯¼æ€§æ³¨é‡Š
          4. **TODO/FIXME**: åˆ—å‡ºæ‰€æœ‰å¾…å¤„ç†é¡¹
          5. **å¤æ‚åº¦**: è¯†åˆ«é«˜å¤æ‚åº¦çš„æ¨¡å—

          ä»¥è¡¨æ ¼å½¢å¼è¾“å‡ºå‘ç°çš„é—®é¢˜ï¼ŒæŒ‰ä¸¥é‡ç¨‹åº¦æ’åºã€‚
          PROMPT

          claude --print "$(cat /tmp/quality-prompt.md)" > /tmp/quality-result.md 2>&1 || true
          cat /tmp/quality-result.md

      - name: Summary
        run: |
          echo "## ğŸ“Š å‘¨åº¦ä»£ç è´¨é‡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat /tmp/quality-result.md >> $GITHUB_STEP_SUMMARY

  # ============================================
  # ä¾èµ–å®‰å…¨å®¡è®¡
  # ============================================
  dependency-audit:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.task == 'all' || github.event.inputs.task == 'dependency-audit')

    permissions:
      contents: read
      issues: write
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check for Package Files
        id: check-deps
        run: |
          has_npm=false
          has_pip=false

          [ -f "package.json" ] && has_npm=true
          [ -f "requirements.txt" ] || [ -f "pyproject.toml" ] && has_pip=true

          echo "has_npm=$has_npm" >> $GITHUB_OUTPUT
          echo "has_pip=$has_pip" >> $GITHUB_OUTPUT

      - name: NPM Audit
        if: steps.check-deps.outputs.has_npm == 'true'
        continue-on-error: true
        run: |
          npm audit --json > /tmp/npm-audit.json 2>&1 || true
          echo "## NPM Audit Results" >> /tmp/audit-result.md
          npm audit 2>&1 | head -100 >> /tmp/audit-result.md || true

      - name: Pip Audit
        if: steps.check-deps.outputs.has_pip == 'true'
        continue-on-error: true
        run: |
          pip install pip-audit
          echo "## Pip Audit Results" >> /tmp/audit-result.md
          pip-audit 2>&1 | head -100 >> /tmp/audit-result.md || true

      - name: Create Security Issue if Vulnerabilities Found
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let result = '';
            try {
              result = fs.readFileSync('/tmp/audit-result.md', 'utf8');
            } catch (e) {
              result = 'æœªæ£€æµ‹åˆ°ä¾èµ–æ–‡ä»¶æˆ–å®¡è®¡å®Œæˆæ— é—®é¢˜ã€‚';
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰æ¼æ´
            if (result.includes('high') || result.includes('critical') || result.includes('vulnerability')) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ”’ ä¾èµ–å®‰å…¨å®¡è®¡å‘ç°æ¼æ´',
                body: `## ä¾èµ–å®‰å…¨å®¡è®¡æŠ¥å‘Š\n\n${result}\n\n---\n<sub>ğŸ¤– ç”± Claude Code è‡ªåŠ¨ç”Ÿæˆ | ${new Date().toISOString().split('T')[0]}</sub>`,
                labels: ['security', 'dependencies', 'automated']
              });
            }

      - name: Summary
        run: |
          echo "## ğŸ”’ ä¾èµ–å®‰å…¨å®¡è®¡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f /tmp/audit-result.md ]; then
            cat /tmp/audit-result.md >> $GITHUB_STEP_SUMMARY
          else
            echo "æœªæ£€æµ‹åˆ°ä¾èµ–æ–‡ä»¶ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
